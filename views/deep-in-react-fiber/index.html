<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react深入：Fiber架构 | Revan1i</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Sometimes You Gotta Run Before You Can Walk">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.3aad6fc3.css" as="style"><link rel="preload" href="/assets/js/app.0bcb8f95.js" as="script"><link rel="preload" href="/assets/js/3.5b392386.js" as="script"><link rel="preload" href="/assets/js/1.04eea0a2.js" as="script"><link rel="preload" href="/assets/js/8.34378de2.js" as="script"><link rel="prefetch" href="/assets/js/10.c44c00bd.js"><link rel="prefetch" href="/assets/js/11.32683852.js"><link rel="prefetch" href="/assets/js/12.3b54f12c.js"><link rel="prefetch" href="/assets/js/13.595cf160.js"><link rel="prefetch" href="/assets/js/14.13c7cd90.js"><link rel="prefetch" href="/assets/js/15.0d15e9c8.js"><link rel="prefetch" href="/assets/js/16.cfcddd49.js"><link rel="prefetch" href="/assets/js/17.1dd75d0b.js"><link rel="prefetch" href="/assets/js/18.59ef32ab.js"><link rel="prefetch" href="/assets/js/19.800f2e02.js"><link rel="prefetch" href="/assets/js/20.ce8ddc61.js"><link rel="prefetch" href="/assets/js/21.8ce5b0d9.js"><link rel="prefetch" href="/assets/js/22.e1f58af1.js"><link rel="prefetch" href="/assets/js/23.12b730df.js"><link rel="prefetch" href="/assets/js/24.5e4f2d41.js"><link rel="prefetch" href="/assets/js/25.1943b348.js"><link rel="prefetch" href="/assets/js/26.5e0c18f8.js"><link rel="prefetch" href="/assets/js/27.2e899db1.js"><link rel="prefetch" href="/assets/js/28.c7bfff1b.js"><link rel="prefetch" href="/assets/js/29.e113306f.js"><link rel="prefetch" href="/assets/js/30.f203f033.js"><link rel="prefetch" href="/assets/js/31.c76fad02.js"><link rel="prefetch" href="/assets/js/32.96e63591.js"><link rel="prefetch" href="/assets/js/33.45899018.js"><link rel="prefetch" href="/assets/js/34.44cefe7a.js"><link rel="prefetch" href="/assets/js/35.6102d7c7.js"><link rel="prefetch" href="/assets/js/36.ad93c8c9.js"><link rel="prefetch" href="/assets/js/37.24741adc.js"><link rel="prefetch" href="/assets/js/4.affcbbfd.js"><link rel="prefetch" href="/assets/js/5.21df6b95.js"><link rel="prefetch" href="/assets/js/6.9c4782ed.js"><link rel="prefetch" href="/assets/js/7.f2808cb9.js"><link rel="prefetch" href="/assets/js/9.d19b22fa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3aad6fc3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container no-sidebar" data-v-319dd33c><div data-v-319dd33c><div id="loader-wrapper" class="loading-wrapper" data-v-4b73742e data-v-319dd33c data-v-319dd33c><div class="loader-main" data-v-4b73742e><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div><div data-v-4b73742e></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-1e2a0cc0 data-v-319dd33c data-v-319dd33c><h3 class="title" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0>Revan1i</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0><input type="password" value="" data-v-1e2a0cc0> <span data-v-1e2a0cc0>Konck! Knock!</span> <button data-v-1e2a0cc0>OK</button></label> <div class="footer" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0><span data-v-1e2a0cc0><i class="iconfont reco-theme" data-v-1e2a0cc0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-1e2a0cc0>vuePress-theme-reco</a></span> <span data-v-1e2a0cc0><i class="iconfont reco-copyright" data-v-1e2a0cc0></i> <a data-v-1e2a0cc0><span data-v-1e2a0cc0>revan1i</span>
            
          <span data-v-1e2a0cc0>2019 - </span>
          2020
        </a></span></div></div> <div class="hide" data-v-319dd33c><header class="navbar" data-v-319dd33c><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Revan1i" class="logo"> <span class="site-name">Revan1i</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/javascript/" class="nav-link"><i class="iconfont undefined"></i>
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/categories/css/" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/js/" class="nav-link"><i class="iconfont undefined"></i>
  js
</a></li><li class="dropdown-item"><!----> <a href="/categories/how/" class="nav-link"><i class="iconfont undefined"></i>
  how
</a></li><li class="dropdown-item"><!----> <a href="/categories/math/" class="nav-link"><i class="iconfont undefined"></i>
  math
</a></li><li class="dropdown-item"><!----> <a href="/categories/regexp/" class="nav-link"><i class="iconfont undefined"></i>
  regexp
</a></li><li class="dropdown-item"><!----> <a href="/categories/algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/feeling/" class="nav-link"><i class="iconfont undefined"></i>
  feeling
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/revanli" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-319dd33c></div> <aside class="sidebar" data-v-319dd33c><div class="personal-info-wrapper" data-v-6c8ffc9c><img src="/arc-reactor.png" alt="author-avatar" class="personal-img" data-v-6c8ffc9c> <h3 class="name" data-v-6c8ffc9c>
    revan1i
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>25</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>20</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/javascript/" class="nav-link"><i class="iconfont undefined"></i>
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/categories/css/" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/categories/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/categories/js/" class="nav-link"><i class="iconfont undefined"></i>
  js
</a></li><li class="dropdown-item"><!----> <a href="/categories/how/" class="nav-link"><i class="iconfont undefined"></i>
  how
</a></li><li class="dropdown-item"><!----> <a href="/categories/math/" class="nav-link"><i class="iconfont undefined"></i>
  math
</a></li><li class="dropdown-item"><!----> <a href="/categories/regexp/" class="nav-link"><i class="iconfont undefined"></i>
  regexp
</a></li><li class="dropdown-item"><!----> <a href="/categories/algorithm/" class="nav-link"><i class="iconfont undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/feeling/" class="nav-link"><i class="iconfont undefined"></i>
  feeling
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/revanli" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-1e2a0cc0 data-v-319dd33c><h3 class="title" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0>react深入：Fiber架构</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0><input type="password" value="" data-v-1e2a0cc0> <span data-v-1e2a0cc0>Konck! Knock!</span> <button data-v-1e2a0cc0>OK</button></label> <div class="footer" style="display:none;" data-v-1e2a0cc0 data-v-1e2a0cc0><span data-v-1e2a0cc0><i class="iconfont reco-theme" data-v-1e2a0cc0></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-1e2a0cc0>vuePress-theme-reco</a></span> <span data-v-1e2a0cc0><i class="iconfont reco-copyright" data-v-1e2a0cc0></i> <a data-v-1e2a0cc0><span data-v-1e2a0cc0>revan1i</span>
            
          <span data-v-1e2a0cc0>2019 - </span>
          2020
        </a></span></div></div> <div data-v-319dd33c><main class="page"><div class="page-title" style="display:none;"><h1>react深入：Fiber架构</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>revan1i</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2020-03-10 11:13:58</span></i> <i class="iconfont reco-eye" data-v-484a899e><span id="/views/deep-in-react-fiber/" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-484a899e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      react
    </span><span class="tag-item" data-v-484a899e>
      source code
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><blockquote><p>文中 React 相关源码版本, v16.8.0</p></blockquote> <h2 id="fiber-是什么？"><a href="#fiber-是什么？" aria-hidden="true" class="header-anchor">#</a> Fiber 是什么？</h2> <p>Fiber 是 React v16 中启用的一种全新的架构，旨在解决大型 React 项目的性能问题。<br>
在开始详细介绍 Fiber 之前，让我们先了解本文的核心：Reconciliation 模块。</p> <h2 id="reconciliation-模块"><a href="#reconciliation-模块" aria-hidden="true" class="header-anchor">#</a> Reconciliation 模块</h2> <p>Reconciliation 模块也叫协调模块。主要负责任务协调、生命周期函数管理等。React 16 版本之前这个模块使用 Stack Reconciler 调度算法，16 版本之后重构为 Fiber Reconciler，一种全新的调度算法。在 React Conf 2017 上 Lin Clark 的<a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;list=PLb0IAmt7-GS3fZ46IGFirdqKTIxlws7e0&amp;index=5" target="_blank" rel="noopener noreferrer">A
Cartoon intro to Fiber<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，就用漫画的方式形象的展示了 Stack Reconciler 与 Fiber Reconciler 运行区别。</p> <p><img src="/assets/img/figure-stack-reconciler-vs-fiber-reconciler.8144d54e.png" alt="stack-reconciler-vs-fiber-reconciler"></p> <h3 id="stack-reconciler"><a href="#stack-reconciler" aria-hidden="true" class="header-anchor">#</a> Stack Reconciler</h3> <p>Stack Reconciler 调度算法，通过自顶向下递归的形式遍历 Virtual DOM, 递归一但进行，想要中断和恢复就不容易操作，如果递归栈比较多，那么 JS 线程会一直占用主进程，就有可能导致页面卡顿。为什么呢？因为浏览器除了 JS 进程以外，还包括 UI 渲染线程、事件线程、定时器触发线程、HTTP 请求线程等。JS 线程是可以操作 DOM 的，如果在操作 DOM 的同时 UI 线程也在进行渲染的话，就会发生不可预期的展示结果，因此 JS 线程与 UI 渲染线程是互斥的，每当 JS 线程执行时，UI 渲染线程会挂起，UI 更新会被保存在队列中，等待 JS 线程空闲后立即被执行。对于事件线程而言，当一个事件被触发时该线程会把事件添加到队列末尾，等待 JS 线程空闲后处理。因此，长时间的 JS 持续执行，就会造成 UI 渲染线程长时间地挂起，触发的事件也得不到响应，用户层面就会感知到页面卡顿甚至卡死了。那么 JS 执行时间多长会是合理的呢？现在大多数设备的帧率都是 60 帧/秒，也就是每帧 16.6ms 左右用户会感觉相当流畅。浏览器一帧内完成的任务如下图所示：</p> <p><img src="/assets/img/figure-life-of-a-frame.e12b9903.png" alt="life-of-a-frame"></p> <blockquote><p>图片来源：<a href="https://juejin.im/post/5ad71f39f265da239f07e862" target="_blank" rel="noopener noreferrer">你应该知道的 requestIdleCallback<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>包括以下几个部分</p> <ul><li>处理用户的交互</li> <li>JS 解析执行</li> <li>帧开始。窗口尺寸变更，页面滚动处理</li> <li>requestAnimationFrame callbacks</li> <li>布局 Layout</li> <li>绘制 Paint
在一帧中，我们需要将 JS 执行时间控制在合理的范围内，不影响后续 Layout 与 Paint 的过程，尽量保证 JS 的执行时间加上其他步骤的时间不能超过 16ms。</li></ul> <p>那么如何让单线程的 JS 把执行时间控制在合理的范围内？对于前端框架来说，解决这个问题有三个方向：</p> <p>1、优化每一个任务，让他有多快就多快，挤压 CPU 运算量<br>
2、快速响应用户，让用户觉得够快，不能阻塞用户的交互<br>
3、尝试 Worker 多线程</p> <p>Vue 选择的是第一种，使用<code>模板</code>让它有了很多优化的空间，配合响应式的机制可以让 Vue 精确的更新节点，有兴趣的读者可以了解下
<a href="https://www.yuque.com/vueconf/2019/gwn1z0" target="_blank" rel="noopener noreferrer">尤雨溪 2019 Vue Conf 的演讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。React 选择了第二种方案，也就是引入 Fiber 架构。Worker 多线程在保证状态和视图一致性会相当的麻烦。</p> <p>下面我们来看看 Fiber 架构具体是怎样优化 Reconcilation 这种 CPU 密集型操作的。</p> <h3 id="fiber-reconciler"><a href="#fiber-reconciler" aria-hidden="true" class="header-anchor">#</a> Fiber Reconciler</h3> <p>为了防止 Reconcilation 阶段长时间的占用浏览器资源，React 通过 Fiber 架构改进 Reconcilation 过程，<strong>使得渲染过程可以被中断，允许渲染过程分段完成，而不必需一次性完成，中间可以返回至主进程控制执行其他高优先级的任务，浏览器空闲后恢复渲染。</strong> 这种改进后的调度算法为 Fiber Reconciler。</p> <p>那么问题来了：</p> <ul><li>渲染过程如何分段？</li> <li>如何知道浏览器空闲？</li> <li>如何设定优先级？</li> <li>高优先级如何插队，低优先级如何恢复？</li></ul> <p>接下来整个 Fiber 架构就是来解决这些问题的。</p> <h2 id="requestidlecallback"><a href="#requestidlecallback" aria-hidden="true" class="header-anchor">#</a> requestIdleCallback</h2> <p>上面说到理想的一帧时间是<code>16.6ms</code>，如果浏览器处理完布局和绘制任务之后，还有剩余的时间，就会执行<code>requestIdleCallback</code>回调，回调函数会接受到一个名为<code>IdleDeadline</code>的参数，这个参数可以获取当前空闲时间以及回调是否在超时时间前执行的状态。由于浏览器可能始终处于繁忙的状态，导致 callback 一直无法执行，它还能够设置超时时间（timeout），一旦超过时间（didTimeout）会使任务强制执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 浏览器执行线程空闲时间调用 work，超过 2000ms 后立即必须执行</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>work<span class="token punctuation">,</span> <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">work</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果有剩余时间，或者任务已经超时，并且存在任务就需要执行</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> deadline<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    tasks<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do work</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当前存在任务，再次调用 requestIdleCallback，会在空闲时间执行 work</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>work<span class="token punctuation">,</span> <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="/assets/img/figure-frame-idle.dff47141.png" alt="frame-idle"></p> <blockquote><p>图片来源：<a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener noreferrer">这可能是最通俗的 React Fiber(时间分片) 打开方式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>结合上图得知，<code>requestIdleCallback</code>是在 Layout 与 Paint 之后执行的，因此不建议在<code>requestIdleCallback</code>里做 DOM 操作（如 getBoundingClientRect、clientWidth 等操作），会重新触发 Layout 与 Paint，另外由于修改 DOM 操作的时间是不可预测的，因此很容易超出当前帧空闲时间的阈值，如果要操作 DOM， 推荐的做法是在<code>requestAnimationFrame</code>里面做 DOM 的修改，可以在<code>requestIdleCallback</code>里面构建 Document Fragment ，然后在下一帧的<code>requestAnimationFrame</code>里面应用 Fragment。因为 <code>requestIdleCallback</code>的兼容性比较差，React 内部通过 <code>requestAnimationFrame</code> 作为 polyfill，通过帧率动态调整，计算 timeRemaing，模拟<code>requestIdleCallback</code>，从而实现时间分片（Time Slicing），一个时间片就是一个渲染帧内 JS 能获得的最大执行时间。</p> <ul><li>polyfill</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ref: https://github.com/facebook/react/blob/v16.8.0/packages/scheduler/src/Scheduler.js#L455</span>
<span class="token keyword">var</span> <span class="token constant">ANIMATION_FRAME_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">// ...</span>

<span class="token comment">// 当前tab激活， requestAnimationFrame 工作</span>
<span class="token comment">// 当前tab不激活，setTimeout 工作</span>
<span class="token comment">// 两者交替接管任务执行</span>
<span class="token keyword">var</span> <span class="token function-variable function">requestAnimationFrameWithTimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// schedule rAF and also a setTimeout</span>
  rAFID <span class="token operator">=</span> <span class="token function">localRequestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cancel the setTimeout</span>
    <span class="token function">localClearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  rAFTimeoutID <span class="token operator">=</span> <span class="token function">localSetTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cancel the requestAnimationFrame</span>
    <span class="token function">localCancelAnimationFrame</span><span class="token punctuation">(</span>rAFID<span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">ANIMATION_FRAME_TIMEOUT</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>计算每一帧的截止时间</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ref: https://github.com/facebook/react/blob/v16.8.0/packages/scheduler/src/Scheduler.js#L615</span>
<span class="token keyword">var</span> scheduledHostCallback <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">//代表任务链表的执行器</span>
<span class="token keyword">var</span> timeoutTime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">//代表最高优先级任务firstCallbackNode的过期时间</span>
<span class="token keyword">var</span> activeFrameTime <span class="token operator">=</span> <span class="token number">33</span> <span class="token comment">// 一帧的渲染时间33ms，这里假设 1s 30帧</span>
<span class="token keyword">var</span> frameDeadline <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//代表一帧的过期时间，通过rAF回调入参t加上activeFrameTime来计算</span>

<span class="token comment">// rAF的回调是每一帧开始的时候，所以适合做一些轻量任务，不然会阻塞渲染。</span>
<span class="token keyword">function</span> <span class="token function">animationTick</span><span class="token punctuation">(</span><span class="token parameter">rafTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 有任务再进行递归，没任务的话不需要工作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledHostCallback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> nextFrameTime <span class="token operator">=</span> rafTime <span class="token operator">-</span> frameDeadline <span class="token operator">+</span> activeFrameTime

  <span class="token comment">// 动态帧率计算，一开始假设设备是 30hz, 即一帧是 33ms, 这里对每一帧渲染时间进行优化,</span>
  <span class="token comment">// 会在渲染过程中不断压缩每一帧的渲染时间，达到系统的刷新频率(60hz为16.6ms)</span>
  activeFrameTime <span class="token operator">=</span>
    nextFrameTime <span class="token operator">&lt;</span> previousFrameTime <span class="token operator">?</span> previousFrameTime <span class="token punctuation">:</span> nextFrameTime

  <span class="token comment">//计算当前帧的截止时间，用开始时间加上每一帧的渲染时间</span>
  frameDeadline <span class="token operator">=</span> rafTime <span class="token operator">+</span> activeFrameTime
<span class="token punctuation">}</span>

<span class="token comment">// 某个地方会调用</span>
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>animationTick<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li>通过消息通道<code>MessageChannel</code>把回调延迟到 Paint 操作后执行</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ref: https://github.com/facebook/react/blob/v16.8.0/packages/scheduler/src/Scheduler.js#L517</span>
<span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2 <span class="token comment">//port2用来发消息</span>
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// port1监听消息的回调来做任务调度的具体工作</span>
  <span class="token comment">// onmessage的回调函数的调用时机是在一帧的paint完成之后,所以适合做一些重型任务，也能保证页面流畅不卡顿</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="任务的优先级"><a href="#任务的优先级" aria-hidden="true" class="header-anchor">#</a> 任务的优先级</h2> <p>为了避免任务被饿死，可以设置一个超时时间，根据不同的优先级超时时间有所差异。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 分为5种优先级，数字越小优先级越高</span>
<span class="token keyword">var</span> ImmediatePriority <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">//最高优先级</span>
<span class="token keyword">var</span> UserBlockingPriority <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">//用户阻塞型优先级</span>
<span class="token keyword">var</span> NormalPriority <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">//普通优先级</span>
<span class="token keyword">var</span> LowPriority <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// 低优先级</span>
<span class="token keyword">var</span> IdlePriority <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// 空闲优先级</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这 5 中优先级对应的 5 个过期时间</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Max 31 bit integer. The max integer size in V8 for 32-bit systems.</span>
<span class="token comment">// Math.pow(2, 30) - 1</span>
<span class="token keyword">var</span> maxSigned31BitInt <span class="token operator">=</span> <span class="token number">1073741823</span>

<span class="token comment">// 立马过期 ==&gt; ImmediatePriority</span>
<span class="token keyword">var</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// 250ms以后过期</span>
<span class="token keyword">var</span> <span class="token constant">USER_BLOCKING_PRIORITY</span> <span class="token operator">=</span> <span class="token number">250</span>
<span class="token comment">//</span>
<span class="token keyword">var</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">5000</span>
<span class="token comment">//</span>
<span class="token keyword">var</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10000</span>
<span class="token comment">// 永不过期, 大概12.427天，就是打开一个tab，大概12.427天过期</span>
<span class="token keyword">var</span> <span class="token constant">IDLE_PRIORITY</span> <span class="token operator">=</span> maxSigned31BitInt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><a href="https://github.com/facebook/react/blob/v16.8.0/packages/scheduler/src/Scheduler.js#L69" target="_blank" rel="noopener noreferrer">React 内对任务的操作使用了双向循环链表结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="https://github.com/facebook/react/blob/v16.8.0/packages/scheduler/src/Scheduler.js#L326" target="_blank" rel="noopener noreferrer">每个任务在添加到链表里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的时候，都会通过 performance.now() + timeout来得出这个任务的过期时间，随着时间的推移，当前时间会越来越接近这个过期时间，所以过期时间越小的代表优先级越高。</p> <p>以上，对 React 的基本概念进行了介绍，下面通过分析源码进一步的了解 Fiber 架构。</p> <h2 id="源码分析"><a href="#源码分析" aria-hidden="true" class="header-anchor">#</a> 源码分析</h2> <p>React Fiber 架构引入了新的数据结构：fiber节点</p> <h3 id="fiber"><a href="#fiber" aria-hidden="true" class="header-anchor">#</a> fiber</h3> <p>fiber节点结构关键重要字段如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 跟当前Fiber相关本地状态（比如浏览器环境就是DOM节点）</span>
  stateNode<span class="token punctuation">:</span> any<span class="token punctuation">,</span>

    <span class="token comment">// 单链表树结构</span>
  <span class="token keyword">return</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// 指向他在Fiber节点树中的`parent`，用来在处理完这个节点之后向上返回</span>
  child<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// 指向自己的第一个子节点</span>
  sibling<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// 指向自己的兄弟结构，兄弟节点的return指向同一个父节点</span>

  <span class="token comment">// 更新相关</span>
  pendingProps<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  <span class="token comment">// 新的变动带来的新的props</span>
  memoizedProps<span class="token punctuation">:</span> any<span class="token punctuation">,</span>  <span class="token comment">// 上一次渲染完成之后的props</span>
  updateQueue<span class="token punctuation">:</span> UpdateQueue<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// 该Fiber对应的组件产生的Update会存放在这个队列里面</span>
  memoizedState<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 上一次渲染的时候的state</span>

  <span class="token comment">// Scheduler 相关</span>
  expirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>  <span class="token comment">// 代表任务在未来的哪个时间点应该被完成，不包括他的子树产生的任务</span>
  <span class="token comment">// 快速确定子树中是否有不在等待的变化</span>
  childExpirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span>

 <span class="token comment">// 在Fiber树更新的过程中，每个Fiber都会有一个跟其对应的Fiber</span>
  <span class="token comment">// 我们称他为`current &lt;==&gt; workInProgress`</span>
  <span class="token comment">// 在渲染完成之后他们会交换位置</span>
  alternate<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// Effect 相关的</span>
  effectTag<span class="token punctuation">:</span> SideEffectTag<span class="token punctuation">,</span> <span class="token comment">// 用来记录Side Effect</span>
  nextEffect<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 单链表用来快速查找下一个side effect</span>
  firstEffect<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// 子树中第一个side effect</span>
  lastEffect<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 子树中最后一个side effect</span>
  <span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>fiber 树结构图（链表结构）如下：
</p><div align="center"><img src="/assets/img/figure-fiber.57edea49.png" width="400" alt=""></div><p></p> <blockquote><p>图片来源：<a href="https://juejin.im/post/5b7016606fb9a0099406f8de" target="_blank" rel="noopener noreferrer">React16源码之React Fiber架构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="源码函数调用流程"><a href="#源码函数调用流程" aria-hidden="true" class="header-anchor">#</a> 源码函数调用流程</h2> <p>上文中说到 Reconciliation 模块（协调模块），主要负责任务协调、生命周期函数管理等。它的工作氛围两部分：</p> <p>1、reconciliation<br>
简单来说就是找到更新工作，通过 Diff Fiber Tree 找出要做的更新工作，因为使用了链表结构，在迭代的过程可以缓存计算结果，打断计算结果，以及恢复执行。</p> <p>2、commit<br>
提交更新并调用对应渲染模块进行渲染，为了防止页面抖动，该过程是同步且不能被打断。</p> <p>接下来看看这两个阶段具体的函数调用流程。</p> <h3 id="reconciliation阶段"><a href="#reconciliation阶段" aria-hidden="true" class="header-anchor">#</a> reconciliation阶段</h3> <p>我们以 ReactDOM.render() 方法为入口，看看 reconciliation 阶段的函数调用流程：
<img src="/assets/img/figure-reconciliation.ac11f9b3.png" alt="figure-reconfiliation"></p> <p>从上图可以看到，整个流程可以划分为三个部分，简单的概括下三部分的工作：</p> <p>1、第一部分从 <code>ReactDOM.render()</code> 方法开始，把接收的 React Element 转换为 Fiber 节点，并为其设置优先级，创建 Update，加入到更新队列，这部分主要是做一些初始数据的准备。</p> <p>2、第二部分主要是三个函数：<code>scheduleWork</code>、<code>requestWork</code>、<code>performWork</code>，即安排工作、申请工作、正式工作三部曲，React 16 新增的异步调用功能在这部分实现，这部分就是 <code>Schedule 阶段</code>。</p> <p>3、第三部分是一个大循环，遍历所有的 Fiber 节点，通过 Diff 算法计算所有更新工作，产出 EffectList 给到 commit 阶段使用，这部分的核心是 <code>beginWork</code> 函数。</p> <h4 id="第一部分"><a href="#第一部分" aria-hidden="true" class="header-anchor">#</a> 第一部分</h4> <p>第一部分主要是做一些初始数据的准备，感兴趣的读者可<a href="https://github.com/facebook/react/blob/v16.8.0/packages/react-dom/src/client/ReactDOM.js#L673" target="_blank" rel="noopener noreferrer">自行前往查阅<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h4 id="第二部分：任务协调"><a href="#第二部分：任务协调" aria-hidden="true" class="header-anchor">#</a> 第二部分：任务协调</h4> <p>核心函数：<code>scheduleWork</code>、<code>requestWork</code>、<code>performWork</code> (安排工作、申请工作、正式工作三部曲)
<img src="/assets/img/figure-schedule-work.80c02aaa.png" alt="figure-shedule-work"> <a href="https://github.com/facebook/react/blob/v16.8.0/packages/react-reconciler/src/ReactFiberScheduler.js#L1812" target="_blank" rel="noopener noreferrer"><code>scheduleWork</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>函数内部核心是<code>scheduleWorkToRoot</code>，这个函数从触发 setState 的 Fiber 节点，不断向上回溯，通知沿途上的 Fiber 节点，你有子孙节点被更新了，直至最顶端 HostRoot。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span><span class="token punctuation">:</span> FiberRoot <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>

  <span class="token comment">// Update the source fiber's expiration time</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Walk the parent path to the root and update the child expiration time.</span>
  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      alternate <span class="token operator">=</span> node<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        alternate <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">&lt;</span> expirationTime
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alternate<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 向上追溯</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><code>requestWork</code>比较简短，判断什么样的方式去执行更新</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// requestWork is called by the scheduler whenever a root receives an update.</span>
<span class="token comment">// It's up to the renderer to call renderRoot at some point in the future.</span>
<span class="token keyword">function</span> <span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">:</span> FiberRoot<span class="token punctuation">,</span> expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">addRootToSchedule</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRendering<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Prevent reentrancy. Remaining work will be scheduled at the end of</span>
    <span class="token comment">// the currently rendering batch.</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush work at the end of the batch.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnbatchingUpdates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...unless we're inside unbatchedUpdates, in which case we should</span>
      <span class="token comment">// flush it now.</span>
      nextFlushedRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
      nextFlushedExpirationTime <span class="token operator">=</span> Sync<span class="token punctuation">;</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// TODO: Get rid of Sync and use current time?</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>performSyncWork</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">performWork</span><span class="token punctuation">(</span>Sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">performWork</span><span class="token punctuation">(</span><span class="token parameter">minExpirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span> isYieldy<span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Keep working on roots until there's no more work, or until there's a higher</span>
  <span class="token comment">// priority event.</span>
  <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableUserTimingAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> didExpire <span class="token operator">=</span> nextFlushedExpirationTime <span class="token operator">&gt;</span> currentRendererTime<span class="token punctuation">;</span>
      <span class="token keyword">const</span> timeout <span class="token operator">=</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span>nextFlushedExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">stopRequestCallbackTimer</span><span class="token punctuation">(</span>didExpire<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      nextFlushedRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
      minExpirationTime <span class="token operator">&lt;=</span> nextFlushedExpirationTime <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>didYield <span class="token operator">&amp;&amp;</span> currentRendererTime <span class="token operator">&gt;</span> nextFlushedExpirationTime<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>
        nextFlushedRoot<span class="token punctuation">,</span>
        nextFlushedExpirationTime<span class="token punctuation">,</span>
        currentRendererTime <span class="token operator">&gt;</span> nextFlushedExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentSchedulerTime <span class="token operator">=</span> currentRendererTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      nextFlushedRoot <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      nextFlushedExpirationTime <span class="token operator">!==</span> NoWork <span class="token operator">&amp;&amp;</span>
      minExpirationTime <span class="token operator">&lt;=</span> nextFlushedExpirationTime
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span>nextFlushedRoot<span class="token punctuation">,</span> nextFlushedExpirationTime<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We're done flushing work. Either we ran out of time in this callback,</span>
  <span class="token comment">// or there's no more work left with sufficient priority.</span>

  <span class="token comment">// If we're inside a callback, set this to false since we just completed it.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
    callbackID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// If there's work left over, schedule a new callback.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFlushedExpirationTime <span class="token operator">!==</span> NoWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>nextFlushedRoot<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> FiberRoot<span class="token punctuation">)</span><span class="token punctuation">,</span>
      nextFlushedExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Clean-up.</span>
  <span class="token function">finishRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p><strong>scheduleCallback</strong>这个内部函数还没转正，使用的是<strong>unstable_scheduleCallback</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">unstable_scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> deprecated_options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> startTime <span class="token operator">=</span>
    currentEventStartTime <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> currentEventStartTime <span class="token punctuation">:</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> deprecated_options <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
    deprecated_options <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> deprecated_options<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'number'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// FIXME: Remove this branch once we lift expiration times out of React.</span>
    expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> deprecated_options<span class="token punctuation">.</span>timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentPriorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ImmediatePriority<span class="token punctuation">:</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> UserBlockingPriority<span class="token punctuation">:</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> <span class="token constant">USER_BLOCKING_PRIORITY</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> IdlePriority<span class="token punctuation">:</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> <span class="token constant">IDLE_PRIORITY</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> LowPriority<span class="token punctuation">:</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> NormalPriority<span class="token punctuation">:</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> newNode <span class="token operator">=</span> <span class="token punctuation">{</span>
    callback<span class="token punctuation">,</span>
    priorityLevel<span class="token punctuation">:</span> currentPriorityLevel<span class="token punctuation">,</span>
    expirationTime<span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    previous<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Insert the new callback into the list, ordered first by expiration, then</span>
  <span class="token comment">// by insertion. So the new callback is inserted any other callback with</span>
  <span class="token comment">// equal expiration.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCallbackNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first callback in the list.</span>
    firstCallbackNode <span class="token operator">=</span> newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
    <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> node <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> expirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The new callback expires before this one.</span>
        next <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> firstCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// No callback with a later expiration was found, which means the new</span>
      <span class="token comment">// callback has the latest expiration in the list.</span>
      next <span class="token operator">=</span> firstCallbackNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> firstCallbackNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// The new callback has the earliest expiration in the entire list.</span>
      firstCallbackNode <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
      <span class="token function">ensureHostCallbackIsScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> previous <span class="token operator">=</span> next<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
    previous<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span>previous <span class="token operator">=</span> newNode<span class="token punctuation">;</span>
    newNode<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    newNode<span class="token punctuation">.</span>previous <span class="token operator">=</span> previous<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> newNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h4 id="第三部分：beginwork"><a href="#第三部分：beginwork" aria-hidden="true" class="header-anchor">#</a> 第三部分：beginWork</h4> <p>从上面的函数调用流程图可以看到，<code>beginWork</code>在大循环中被调用，返回当前节点的子节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">:</span> Fiber<span class="token punctuation">,</span>
  renderExpirationTime<span class="token punctuation">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>updateExpirationTime <span class="token operator">===</span> NoWork <span class="token operator">||</span> updateExpirationTime <span class="token operator">&gt;</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>
        <span class="token operator">...</span>
      <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>
       <span class="token operator">...</span>
      <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span>
        <span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HostPortal<span class="token punctuation">:</span>
        <span class="token operator">...</span>
      <span class="token keyword">case</span> ContextProvider<span class="token punctuation">:</span>
        <span class="token operator">...</span>
      <span class="token keyword">case</span> Profiler<span class="token punctuation">:</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Before entering the begin phase, clear the expiration time.</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> IndeterminateComponent<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> FunctionalComponent<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionalComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ClassComponent<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostRoot<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostComponent<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostText<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> PlaceholderComponent<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updatePlaceholderComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostPortal<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updatePortalComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ForwardRef<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateForwardRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Fragment<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateFragment</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Mode<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateMode</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Profiler<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateProfiler</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextProvider<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextProvider</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContextConsumer<span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token function">updateContextConsumer</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>这里介绍下React Fiber架构的双缓冲（double-buffering）技术。
<img src="/assets/img/figure-work-in-progress.92cab8a5.png" alt="figure-work-in-progress"></p> <blockquote><p>图片来源：<a href="https://juejin.im/post/5ab7b3a2f265da2378403e57" target="_blank" rel="noopener noreferrer">《React Fiber》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>上图是 Reconciliation 完成后的状态，左边是旧树，右边是WIP树。对于需要变更的节点，都打上了标签。 在提交阶段，React 就会将这些打上标签的节点应用变更。</p> <p>在 React 中，workInProgress 树是一个缓冲，它在 Reconcilation 完毕后一次性提交给浏览器进行渲染，它可以减少内存分配和垃圾回收，旧的 Fiber 树不变动的节点，WIP 会克隆复用。</p> <p>双缓存技术还有另外一个重要的场景就是异常的处理，比如当一个节点抛出异常，仍然可以继续沿用旧树的节点，避免整棵树挂掉。</p> <p>Dan 在 <a href="https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html" target="_blank" rel="noopener noreferrer">Beyond React 16<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 演讲中用了一个非常恰当的比喻，那就是 Git 功能分支，你可以将 WIP 树想象成从旧树中 Fork 出来的功能分支，你在这新分支中添加或移除特性，即使是操作失误也不会影响旧的分支。当你这个分支经过了测试和完善，就可以合并到旧分支，将其替换掉。
</p><div align="center"><img src="/assets/img/figure-git.96a91109.png" alt=""></div><p></p> <p>从 beginWork 源码来看，主要分为两部分，一部分是对 Context 的处理，一部分是根据 fiber 对象的 tag 类型，调用对应的 update 方法。在这里我们重点关注第二部分，以 ClassComponent 类型为例，讲讲 updateClassComponent 函数中做了什么？</p> <p>主要有两部分：生命周期函数的调用及 diff 算法，diff 算法我们单独一篇文章进行讲解。
</p><div align="center"><img src="/assets/img/figure-update-class-component.daf5ca64.png" width="300" height="auto"></div><p></p> <p>current为null，意味着当前的update是组件第一次渲染</p> <p>1、调用 <code>constructClassInstance</code> 构造组件实例，主要是调用 constructor 构造函数，并注入classComponentUpdater</p> <p>2、<code>mountClassInstance</code> 则是调用 <code>getDerivedStateFromProps</code> 生命周期函数（v16） 及 <code>UNSAFE_componentWillMount</code> 生命周期函数</p> <p>current不为null，调用 updateClassInstance 方法</p> <p>1、如果新老 props 不一致，则会调用 <code>UNSAFE_componentWillReceiveProps</code> 生命周期函数</p> <p>2、然后调用 <code>shouldComponentUpdate</code> 生命周期函数，获得 <code>shouldUpdate</code> 值，若未定义此生命周期函数，默认为 true（是否重新渲染），如果 shouldUpdate 为 true，则会调用 <code>UNSAFE_componentWillUpdate</code> 生命周期函数</p> <p>最后调用 <code>finishClassComponent</code> 方法，那么 <code>finishClassComponent</code> 函数 中做了什么呢？</p> <p>如果 shouldUpdate 为false，表示不需要更新，直接返回。<br>
如果 shouldUpdate 为true，调用实例的 render 方法，返回新子节点。<br>
如果是首次渲染，调用 mountChildFibers 创建子节点的Fiber实例。<br>
否则，调用 reconcileChildFibers 对新老子节点进行Diff。</p> <p>以上，就是beginWork函数的整个过程，可以知道遍历完 Fiber 树之后，通过 Diff 算法，可以产出 EffectList，给 commit 阶段使用。</p> <h3 id="commit阶段"><a href="#commit阶段" aria-hidden="true" class="header-anchor">#</a> commit阶段</h3> <p>commit 阶段做的事情是拿到 reconciliation 阶段产出的 EffectList，即所有的更新工作，提交这些
更新工作并调用渲染模块（react-dom）渲染 UI。
<img src="/assets/img/figure-commit.afeee69b.png" alt="figure-commit"></p> <p>1、<strong>commitBeforeMutationLifecycles</strong>
此函数主要保存当前 DOM 的一个快照，执行 <code>getSnapshotBeforeUpdate</code> 生命周期函数</p> <p>2、<strong>commitAllHostEffects</strong>
提交所有更新并渲染</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitAllHostEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recordEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The following switch statement is only concerned about placement,</span>
    <span class="token comment">// updates, and deletions. To avoid needing to add a case for every</span>
    <span class="token comment">// possible bitmap value, we remove the secondary effects from the</span>
    <span class="token comment">// effect tag and switch on that value.</span>
    <span class="token keyword">let</span> primaryEffectTag <span class="token operator">=</span> effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> Placement<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span>
        <span class="token comment">// any life-cycles like componentDidMount gets called.</span>
        <span class="token comment">// TODO: findDOMNode doesn't rely on this any more but isMounted</span>
        <span class="token comment">// does and isMounted is deprecated anyway so we should be able</span>
        <span class="token comment">// to kill this.</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// Placement</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is inserted, before</span>
        <span class="token comment">// any life-cycles like componentDidMount gets called.</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> Update<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> Deletion<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>此函数主要是遍历 EffectList，根据 effectTag，调用对应的 commit 方法，进而调动 react-dom 提供的原生操作 DOM 方法，渲染 UI，操作 DOM 方法有</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  getPublicInstance<span class="token punctuation">,</span>
  supportsMutation<span class="token punctuation">,</span>
  supportsPersistence<span class="token punctuation">,</span>
  commitMount<span class="token punctuation">,</span>
  commitUpdate<span class="token punctuation">,</span>
  resetTextContent<span class="token punctuation">,</span>
  commitTextUpdate<span class="token punctuation">,</span>
  appendChild<span class="token punctuation">,</span>
  appendChildToContainer<span class="token punctuation">,</span>
  insertBefore<span class="token punctuation">,</span>
  insertInContainerBefore<span class="token punctuation">,</span>
  removeChild<span class="token punctuation">,</span>
  removeChildFromContainer<span class="token punctuation">,</span>
  replaceContainerChildren<span class="token punctuation">,</span>
  createContainerChildSet<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在 commit 删除操作时，会执行 <code>componentWillUnmount</code> 生命周期函数</p> <p>3、<strong>commitAllLifeCycles</strong>
以 ClassComponent 为例，生成 UI 渲染之后，会执行后续的生命周期函数。<br>
1)、首次渲染则执行 <code>componentDidMount</code> 生命周期函数。<br>
2)、否则，执行 <code>componentDidUpdate</code> 生命周期函数。</p> <p>以上3步就是 commit 阶段的全过程。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>总的下来介绍完了 Fiber 的整体架构，不得不说一下的就是看 React 源码真的很有难度，调用栈真的很深，需要多次打断点去了解函数的作用。暂时先写到这里，之后有新的体会再更新这篇文章。</p> <h2 id="参考文档"><a href="#参考文档" aria-hidden="true" class="header-anchor">#</a> 参考文档</h2> <p>1、<a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="noopener noreferrer">React Fiber Architecture<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
2、<a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener noreferrer">完全理解 React Fiber<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
3、<a href="https://zhuanlan.zhihu.com/p/60307571" target="_blank" rel="noopener noreferrer">深入剖析 React Concurrent<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
4、<a href="https://mp.weixin.qq.com/s/dONYc-Y96baiXBXpwh1w3A" target="_blank" rel="noopener noreferrer">Deep In React 之浅谈 React Fiber 架构(一)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
5、<a href="https://juejin.im/post/5dadc6045188255a270a0f85" target="_blank" rel="noopener noreferrer">这可能是最通俗的 React Fiber(时间分片) 打开方式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
6、<a href="https://juejin.im/post/5c32c0c86fb9a049b7808665" target="_blank" rel="noopener noreferrer">React Scheduler 源码详解（1）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
7、<a href="https://juejin.im/post/5c61197ff265da2d9e173337" target="_blank" rel="noopener noreferrer">React Scheduler 源码详解（2）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
8、<a href="https://philippspiess.com/scheduling-in-react/" target="_blank" rel="noopener noreferrer">Scheduling in React<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----></main> <!----> <div style="display:none;" data-v-319dd33c data-v-319dd33c><div class="comments-wrapper" data-v-319dd33c><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-a81d141e data-v-a81d141e><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-a81d141e><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-a81d141e></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-a81d141e></path></svg></div></div></div>
    <script src="/assets/js/app.0bcb8f95.js" defer></script><script src="/assets/js/3.5b392386.js" defer></script><script src="/assets/js/1.04eea0a2.js" defer></script><script src="/assets/js/8.34378de2.js" defer></script>
  </body>
</html>
